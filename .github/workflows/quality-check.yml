name: Plugin Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup PHP ${{ matrix.php-version }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, intl
        coverage: none
    
    - name: Display PHP version
      run: php -v
    
    - name: Check PHP Syntax
      run: |
        echo "Checking main plugin file..."
        php -l author-post-guard.php
        
        echo "Checking class files..."
        php -l inc/class-settings.php
        php -l inc/class-notifications.php
        php -l inc/class-updater.php
        
        echo "✓ All PHP files have valid syntax"
    
    - name: Check file structure
      run: |
        echo "Verifying required files exist..."
        test -f author-post-guard.php && echo "✓ Main plugin file"
        test -f README.md && echo "✓ README"
        test -f LICENSE && echo "✓ License"
        test -f CHANGELOG.md && echo "✓ Changelog"
        test -d inc && echo "✓ inc directory"
        test -d assets && echo "✓ assets directory"
        test -f assets/admin-style.css && echo "✓ Admin CSS"
        test -f assets/admin-script.js && echo "✓ Admin JS"
        echo "✓ File structure verified"
    
    - name: Check version consistency
      run: |
        PLUGIN_VERSION=$(grep "Version:" author-post-guard.php | awk '{print $3}')
        CONSTANT_VERSION=$(grep "define( 'APG_VERSION'," author-post-guard.php | cut -d"'" -f4)
        echo "Plugin Header: $PLUGIN_VERSION"
        echo "PHP Constant: $CONSTANT_VERSION"
        
        if [ "$PLUGIN_VERSION" != "$CONSTANT_VERSION" ]; then
          echo "✗ Version mismatch!"
          exit 1
        fi
        
        echo "✓ Versions match: $PLUGIN_VERSION"
    
    - name: Security scan
      run: |
        echo "Checking for security issues..."
        
        # Check for capability checks
        CAP_COUNT=$(grep -r "manage_options" --include="*.php" . | wc -l)
        echo "Capability checks found: $CAP_COUNT"
        if [ $CAP_COUNT -lt 6 ]; then
          echo "⚠ Warning: Few capability checks"
        else
          echo "✓ Good capability coverage"
        fi
        
        # Check for nonce verification
        NONCE_COUNT=$(grep -r "check_ajax_referer\|wp_verify_nonce" --include="*.php" . | wc -l)
        echo "Nonce verifications found: $NONCE_COUNT"
        if [ $NONCE_COUNT -lt 1 ]; then
          echo "✗ No nonce verification found!"
          exit 1
        else
          echo "✓ Nonce verification present"
        fi
        
        # Check for sanitization
        SANITIZE_COUNT=$(grep -r "sanitize_text_field\|esc_html\|esc_url" --include="*.php" . | wc -l)
        echo "Sanitization calls found: $SANITIZE_COUNT"
        if [ $SANITIZE_COUNT -lt 10 ]; then
          echo "⚠ Warning: Limited sanitization"
        else
          echo "✓ Good sanitization coverage"
        fi
        
        # Check for eval() (potential risk)
        EVAL_COUNT=$(grep -r "\beval\s*(" --include="*.php" . | wc -l)
        if [ $EVAL_COUNT -gt 1 ]; then
          echo "⚠ Warning: Multiple eval() usages found"
        elif [ $EVAL_COUNT -eq 1 ]; then
          echo "⚠ Info: One eval() usage (custom PHP feature)"
        else
          echo "✓ No eval() usage"
        fi
        
        echo "✓ Security scan complete"
    
    - name: Check documentation
      run: |
        echo "Verifying documentation completeness..."
        test -f README.md && echo "✓ README.md"
        test -f FEATURES.md && echo "✓ FEATURES.md"
        test -f SECURITY.md && echo "✓ SECURITY.md"
        test -f TESTING.md && echo "✓ TESTING.md"
        test -f DEPLOYMENT.md && echo "✓ DEPLOYMENT.md"
        test -f QUICKSTART.md && echo "✓ QUICKSTART.md"
        test -f PROJECT-SUMMARY.md && echo "✓ PROJECT-SUMMARY.md"
        echo "✓ All documentation present"
    
    - name: Run verification script
      run: |
        chmod +x verify.sh
        ./verify.sh
    
    - name: Check code quality
      run: |
        echo "Checking for debug code..."
        DEBUG_COUNT=$(grep -r "var_dump\|print_r" --include="*.php" . | grep -v "error_log" | wc -l || true)
        if [ $DEBUG_COUNT -gt 0 ]; then
          echo "⚠ Warning: Found $DEBUG_COUNT debug statements"
        else
          echo "✓ No debug code"
        fi
        
        echo "Checking for TODO/FIXME..."
        TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.php" . | wc -l || true)
        if [ $TODO_COUNT -gt 0 ]; then
          echo "⚠ Info: Found $TODO_COUNT TODO/FIXME comments"
          grep -r "TODO\|FIXME" --include="*.php" . || true
        else
          echo "✓ No pending TODOs"
        fi
    
    - name: Summary
      if: success()
      run: |
        echo ""
        echo "=================================================="
        echo "  ✓ All Quality Checks Passed!"
        echo "=================================================="
        echo "PHP Version: ${{ matrix.php-version }}"
        echo "Plugin: Author Post Guard"
        echo "Status: Ready for deployment"
        echo "=================================================="

  build-package:
    name: Build Plugin Package
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Create ZIP package
      run: |
        echo "Building plugin package..."
        mkdir -p build
        
        # Create clean package without dev files
        rsync -av --progress . build/author-post-guard \
          --exclude .git \
          --exclude .github \
          --exclude .gitignore \
          --exclude verify.sh \
          --exclude build
        
        cd build
        zip -r author-post-guard.zip author-post-guard/
        
        echo "✓ Package created: author-post-guard.zip"
        ls -lh author-post-guard.zip
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: author-post-guard-plugin
        path: build/author-post-guard.zip
        retention-days: 30

  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Calculate metrics
      run: |
        echo "Calculating code metrics..."
        
        echo "=== File Count ==="
        find . -type f ! -path "./.git/*" | wc -l
        
        echo "=== Line Count ==="
        wc -l *.md *.php inc/*.php assets/*.{css,js} verify.sh 2>/dev/null | tail -1 || echo "N/A"
        
        echo "=== Package Size ==="
        du -sh . | awk '{print $1}'
        
        echo "=== PHP Files ==="
        find . -name "*.php" ! -path "./.git/*" -exec wc -l {} + | sort -n | tail -10
        
        echo "=== CSS/JS Assets ==="
        find assets -name "*.css" -o -name "*.js" -exec wc -l {} +
        
        echo "=== Documentation ==="
        wc -l *.md | sort -n
        
        echo "✓ Metrics calculated"
